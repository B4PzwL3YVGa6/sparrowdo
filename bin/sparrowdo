#!perl6

use JSON::Tiny;
use Sparrowdo;
use Sparrow6::DSL;
use Config::Simple;


sub MAIN (

  Str  :$host = '127.0.0.1', 
  Str  :$sparrowfile, 
  Str  :$http_proxy, 
  Str  :$https_proxy, 
  Str  :$ssh_user, 
  Str  :$ssh_private_key, 
  Int  :$ssh_port = 22, 
  Bool :$bootstrap = False, 
  Str  :$module_run,
       :$task_run, 
  Bool :$no_sudo = False,
  Bool :$purge_cache = True,
  Bool :$no_color = False,
  Bool :$no_index_update,
  Bool :$local_mode = False,
  Str  :$password,
  Str  :$docker,
  Bool :$vagrant = False,
  Str  :$vagrant_id,
  Str  :$cwd, 
  Str  :$conf,
       :$var
)

{

    my @prepare-host-cmd = (
      "ssh",
      "-q",
      "-o",
      "ConnectionAttempts=1",
      "-o",
      "ConnectTimeout=5",
      "-o",
      "UserKnownHostsFile=/dev/null",
      "-o",
      "StrictHostKeyChecking=no",
      "-tt",
      "$host",
      "mkdir -p ~/.sparrowdo"
    );

    run @prepare-host-cmd;

    my @tar-cmd = (
      'tar',
      '-cf',
      "tasks.tar",
      "sparrowfile"
    );

    run @tar-cmd;

    my @scp-cmd = (
      "scp",
      "-q",
      "-o",
      "ConnectionAttempts=1",
      "-o",
      "ConnectTimeout=5",
      "-o",
      "UserKnownHostsFile=/dev/null",
      "-o",
      "StrictHostKeyChecking=no",
      "tasks.tar",
      "$host:~/sparrowdo",
    );

    run @scp-cmd;

    my @unpack-tasks-cmd = (
      "ssh",
      "-q",
      "-o",
      "ConnectionAttempts=1",
      "-o",
      "ConnectTimeout=5",
      "-o",
      "UserKnownHostsFile=/dev/null",
      "-o",
      "StrictHostKeyChecking=no",
      "-tt",
      "$host",
      "tar -xf ~/.sparrowdo/tasks.tar -C ~/.sparrowdo/"
    );

    run @unpack-tasks-cmd;

    my @ssh-cmd = (
      "ssh",
      "-q",
      "-o",
      "ConnectionAttempts=1",
      "-o",
      "ConnectTimeout=5",
      "-o",
      "UserKnownHostsFile=/dev/null",
      "-o",
      "StrictHostKeyChecking=no",
      "-tt",
      "$host",
      "perl6 -MSparrow6::DSL ~/.sparrowdo/sparrowfile"
    );

    run @ssh-cmd;
    
}

