#!perl6


use Sparrowdo;

use Sparrowdo::Ssh;

use Sparrowdo::Docker;

use Sparrowdo::Utils;

use Sparrow6::DSL;


use Config::Simple;


sub MAIN (

  Str  :$host = '127.0.0.1', 
  Str  :$sparrowfile, 
  Str  :$http_proxy, 
  Str  :$https_proxy, 
  Str  :$ssh_user, 
  Str  :$ssh_private_key, 
  Int  :$ssh_port = 22, 
  Bool :$verbose = False,
  Bool :$debug   = False,
  Bool :$bootstrap = False, 
  Str  :$module_run,
       :$task_run, 
  Bool :$no_sudo = False,
  Bool :$purge_cache = True,
  Bool :$no_color = False,
  Bool :$no_index_update,
  Bool :$local_mode = False,
  Str  :$password,
  Str  :$docker,
  Bool :$vagrant = False,
  Str  :$vagrant_id,
  Str  :$cwd,
  Str  :$conf,
       :$var
)

{


  my $spf = $sparrowfile || 'sparrowfile'; # Sparrowfile to run


  if ($docker) {

    prepare-docker-host($docker,%( verbose => $verbose ));

    if $bootstrap {
      bootstrap-docker-host($docker,%( verbose => $verbose ));
      if ! $spf.IO.e and ! $module_run and ! $task_run { 
        # don't try to run sparrowfile if in bootstrap mode
        # and if sparrowfile does not exist
        say "Congratulations!\nYour system is ready to be configured automatically using Sparrowdo!";
        exit 0;
      }
    }

    die "sparrowfile $spf does not exit" unless $spf.IO ~~ :e;

    create-tasks-archive($spf, %( verbose => $verbose ));

    copy-tasks-docker-host($docker,%( verbose => $verbose ));

    unpack-tasks-docker-host($docker,%( verbose => $verbose ));

    run-tasks-docker-host($docker,$spf,%( verbose => $verbose, debug => $debug ));

  } else {  

    die "sparrowfile $spf does not exit" unless $spf.IO ~~ :e;

    create-tasks-archive($spf, %( verbose => $verbose ));

    prepare-ssh-host($host,%( verbose => $verbose ));

    copy-tasks-ssh-host($host,%( verbose => $verbose ));

    unpack-tasks-ssh-host($host,%( verbose => $verbose ));

    run-tasks-ssh-host($host,$spf,%( verbose => $verbose ));
  }

}

